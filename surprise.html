<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Click Photos — Auto-capture + Supabase upload</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:18px;background:#f7f8fb;color:#0b1220}
    a.link-btn{display:inline-block;padding:10px 14px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none;box-shadow:0 6px 18px rgba(37,99,235,0.18)}
    #cameraUI{display:none;margin-top:14px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 24px rgba(11,18,32,0.06);max-width:720px}
    video{max-width:100%;border-radius:8px;background:#000}
    .controls{display:flex;gap:8px;margin-top:8px}
    button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    button.primary{background:#10b981;color:#fff}
    button.ghost{background:#eef2ff}
    #thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .thumb{width:120px;height:90px;object-fit:cover;border-radius:8px;border:1px solid #e6eef6}
    .note{color:#334155;margin-top:8px;font-size:14px}
    #log{margin-top:12px;color:#0b1220;font-size:14px}
    .small{font-size:13px;color:#475569}
  </style>
</head>
<body>
  <h1>Click Photos — Auto-capture + Supabase upload</h1>
  <p>Click the link to open your device camera and take photos. This version will ask permission, auto-capture a number of photos (default: 10), and upload them to a Supabase Storage bucket. <strong>Use only with explicit consent.</strong></p>  <!-- Config: replace these with your Supabase project values (or use server-side signing for production) -->  <div class="note small">Configuration: set <code>SUPABASE_URL</code>, <code>SUPABASE_ANON_KEY</code> and <code>BUCKET</code> in the script below before deploying.</div><a href="#" id="openCamera" class="link-btn">Open camera & take photos</a>

  <div id="cameraUI" aria-hidden="true">
    <div>
      <video id="preview" autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <button id="captureBtn" class="primary">Capture now</button>
      <button id="flipBtn" class="ghost">Flip camera</button>
      <button id="stopBtn" class="ghost">Stop & close</button>
    </div><div id="thumbContainer">
  <div class="note">Photos taken:</div>
  <div id="thumbs"></div>
</div>

<div id="log"></div>

  </div>  <script type="module">
    // ----- CONFIG (replace these values) -----
    const SUPABASE_URL = 'https://your-supabase-ref.supabase.co'; // <-- put your Supabase project URL
    const SUPABASE_ANON_KEY = 'public-anon-key-here';             // <-- put your anon public key for quick prototyping
    const BUCKET = 'photos';                                     // <-- create this bucket in Supabase storage
    const CAPTURE_COUNT = 10; // minimum number of automatic captures
    const CAPTURE_INTERVAL_MS = 400; // milliseconds between captures (tweak for speed/quality)
    // -----------------------------------------

    // Import supabase client from CDN
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/module/index.js';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI references
    const openCamera = document.getElementById('openCamera');
    const cameraUI = document.getElementById('cameraUI');
    const preview = document.getElementById('preview');
    const captureBtn = document.getElementById('captureBtn');
    const stopBtn = document.getElementById('stopBtn');
    const flipBtn = document.getElementById('flipBtn');
    const thumbs = document.getElementById('thumbs');
    const logEl = document.getElementById('log');

    let stream = null;
    let facingMode = 'environment';
    let autoCaptureRunning = false;
    let autoCaptureCancel = false;

    function log(msg){ logEl.textContent = msg; }

    async function startCamera(autoCapture = true){
      try{
        log('Requesting camera permission...');
        const constraints = { video: { facingMode }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        preview.srcObject = stream;
        cameraUI.style.display = 'block';
        cameraUI.setAttribute('aria-hidden','false');
        openCamera.style.display = 'none';
        log('Camera started.');

        // Optionally auto-capture a set of photos immediately after permission is granted
        if(autoCapture){
          autoCaptureCancel = false;
          await autoCapturePhotos(CAPTURE_COUNT, CAPTURE_INTERVAL_MS);
        }
      }catch(err){
        console.error('startCamera error', err);
        alert('Could not open camera. Make sure your browser supports getUserMedia and you granted permission.\n\n' + err.message);
        log('Permission denied or error.');
      }
    }

    function stopCamera(){
      autoCaptureCancel = true;
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      preview.srcObject = null;
      cameraUI.style.display = 'none';
      cameraUI.setAttribute('aria-hidden','true');
      openCamera.style.display = '';
      log('Camera stopped.');
    }

    function captureToCanvas(){
      if(!stream) return null;
      const canvas = document.createElement('canvas');
      canvas.width = preview.videoWidth || 1280;
      canvas.height = preview.videoHeight || 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
      return canvas;
    }

    function addThumbnailUrl(url){
      const img = document.createElement('img');
      img.src = url;
      img.className = 'thumb';
      img.loading = 'lazy';

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.alignItems = 'center';

      const btnBar = document.createElement('div');
      btnBar.style.display = 'flex';
      btnBar.style.gap = '6px';
      btnBar.style.marginTop = '6px';

      const dl = document.createElement('a');
      dl.href = url;
      dl.download = `photo-${Date.now()}.jpg`;
      dl.textContent = 'Download';
      dl.style.fontSize = '12px';
      dl.style.textDecoration = 'none';
      dl.style.padding = '6px 8px';
      dl.style.borderRadius = '6px';
      dl.style.background = '#eef2ff';

      const rm = document.createElement('button');
      rm.textContent = 'Remove';
      rm.style.fontSize = '12px';
      rm.style.padding = '6px 8px';
      rm.style.borderRadius = '6px';
      rm.onclick = () => { URL.revokeObjectURL(url); container.remove(); };

      btnBar.appendChild(dl);
      btnBar.appendChild(rm);
      container.appendChild(img);
      container.appendChild(btnBar);
      thumbs.appendChild(container);
    }

    // Capture a single photo and return a Blob
    function captureBlob(){
      return new Promise((resolve) => {
        const canvas = captureToCanvas();
        if(!canvas) return resolve(null);
        canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
      });
    }

    // Upload a blob to Supabase Storage
    async function uploadBlobToSupabase(blob, remotePath){
      if(!blob) throw new Error('No blob to upload');
      // convert blob to File so Supabase can infer name/content-type easily
      const file = new File([blob], remotePath.split('/').pop(), { type: blob.type });
      // remotePath should include folder, e.g. captures/filename.jpg
      const { data, error } = await supabase.storage.from(BUCKET).upload(remotePath, file, { contentType: file.type });
      if(error){
        console.error('Supabase upload error', error);
        throw error;
      }
      // get public URL (bucket must be public for direct public url)
      const { data: publicData } = supabase.storage.from(BUCKET).getPublicUrl(remotePath);
      return publicData.publicUrl;
    }

    // Auto-capture n photos at interval ms and upload them
    async function autoCapturePhotos(n = 10, intervalMs = 400){
      if(!stream){ log('Camera not started for auto-capture.'); return; }
      if(autoCaptureRunning){ log('Auto-capture already running.'); return; }
      autoCaptureRunning = true;
      log(`Auto-capturing ${n} photos...`);

      const uploadResults = [];
      for(let i=0; i<n; i++){
        if(autoCaptureCancel) break;
        try{
          const blob = await captureBlob();
          if(!blob) { log('Capture failed'); break; }
          const filename = `capture-${Date.now()}-${i}.jpg`;
          const remotePath = `captures/${filename}`;
          log(`Uploading ${i+1}/${n} ...`);
          // upload (sequential to avoid spikes). For speed you could collect blobs then upload with Promise.all
          const publicUrl = await uploadBlobToSupabase(blob, remotePath);
          uploadResults.push(publicUrl);
          addThumbnailUrl(publicUrl);
        }catch(err){
          console.error('capture/upload error', err);
          log('Error during capture/upload: ' + (err.message || err));
        }
        await new Promise(r => setTimeout(r, intervalMs));
      }

      autoCaptureRunning = false;
      if(autoCaptureCancel) log('Auto-capture cancelled.');
      else log(`Done — uploaded ${uploadResults.length} files.`);
      return uploadResults;
    }

    async function flipCamera(){
      facingMode = (facingMode === 'environment') ? 'user' : 'environment';
      if(stream){
        stopCamera();
        await startCamera(false);
      }
    }

    // Manual capture (button)
    async function captureNow(){
      if(!stream) return;
      const blob = await captureBlob();
      if(!blob) return;
      const filename = `capture-${Date.now()}.jpg`;
      const remotePath = `captures/${filename}`;
      try{
        log('Uploading single photo...');
        const publicUrl = await uploadBlobToSupabase(blob, remotePath);
        addThumbnailUrl(publicUrl);
        log('Uploaded.');
      }catch(err){
        log('Upload failed: ' + err.message);
      }
    }

    // wiring
    openCamera.addEventListener('click', e => { e.preventDefault(); startCamera(true); });
    captureBtn.addEventListener('click', captureNow);
    stopBtn.addEventListener('click', stopCamera);
    flipBtn.addEventListener('click', flipCamera);

    window.addEventListener('beforeunload', stopCamera);

    // Safety note shown to developer in console
    console.log('This demo will upload images to Supabase Storage. Make sure you set SUPABASE_URL, SUPABASE_ANON_KEY and create a bucket named in BUCKET. For production, use server-side signing or authenticated uploads.');
  </script></body>
    </html>
